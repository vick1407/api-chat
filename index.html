<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>API-CHAT</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .hidden {
            display: none;
        }
        #chat {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
        }
        #mensagem {
            width: 80%;
            padding: 10px;
        }
        #enviar {
            padding: 10px;
        }
        .sala {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
            margin: 5px 0;
        }
        .sala:hover {
            color: darkblue;
        }
    </style>
</head>
<body>

    <!-- Seção de Registro de Usuário -->
    <div id="registro">
        <h2>Registrar Usuário</h2>
        <input type="text" id="apelido" placeholder="Digite seu apelido">
        <button id="btn-registrar">Entrar</button>
        <p id="erro-registro" style="color: red;"></p>
    </div>

    <!-- Seção de Lista de Salas -->
    <div id="salas-section" class="hidden">
        <h2>Salas de Chat</h2>
        <div id="salas-lista"></div>
        <h3>Criar Nova Sala</h3>
        <input type="text" id="nome-sala" placeholder="Nome da sala">
        <button id="btn-criar-sala">Criar Sala</button>
        <p id="erro-sala" style="color: red;"></p>
        <button id="btn-sair-salas" style="margin-top: 20px;">Sair</button>
    </div>

    <!-- Seção de Chat da Sala -->
    <div id="chat-section" class="hidden">
        <h2 id="nome-sala-atual">Sala: </h2>
        <div id="chat"></div>
        <input type="text" id="mensagem" placeholder="Digite sua mensagem">
        <button id="enviar">Enviar</button>
        <p id="erro-chat" style="color: red;"></p>
        <button id="btn-sair-chat" style="margin-top: 10px;">Sair da Sala</button>
    </div>

    <script>
        const apiBase = 'http://localhost:3000'; // Ajuste a URL conforme necessário

        let usuarioId = null;
        let salaIdAtual = null;

        // Elementos do DOM
        const registroDiv = document.getElementById('registro');
        const salasSection = document.getElementById('salas-section');
        const chatSection = document.getElementById('chat-section');

        const btnRegistrar = document.getElementById('btn-registrar');
        const btnCriarSala = document.getElementById('btn-criar-sala');
        const btnSairSalas = document.getElementById('btn-sair-salas');
        const btnSairChat = document.getElementById('btn-sair-chat');
        const btnEnviar = document.getElementById('enviar');

        const apelidoInput = document.getElementById('apelido');
        const nomeSalaInput = document.getElementById('nome-sala');
        const salasListaDiv = document.getElementById('salas-lista');
        const chatDiv = document.getElementById('chat');

        const erroRegistro = document.getElementById('erro-registro');
        const erroSala = document.getElementById('erro-sala');
        const erroChat = document.getElementById('erro-chat');

        const nomeSalaAtual = document.getElementById('nome-sala-atual');

        // Registrar Usuário
        btnRegistrar.addEventListener('click', async () => {
            const apelido = apelidoInput.value.trim();
            if (!apelido) {
                erroRegistro.textContent = 'Apelido é necessário.';
                return;
            }
            try {
                const response = await fetch(`${apiBase}/entrar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apelido })
                });
                const data = await response.json();
                if (response.ok) {
                    usuarioId = data._id; // Supondo que a resposta contenha o ID do usuário
                    registroDiv.classList.add('hidden');
                    salasSection.classList.remove('hidden');
                    carregarSalas();
                } else {
                    erroRegistro.textContent = data.error || 'Erro ao registrar usuário.';
                }
            } catch (error) {
                erroRegistro.textContent = 'Erro ao registrar usuário.';
                console.error(error);
            }
        });

        // Carregar Salas
        async function carregarSalas() {
            try {
                const response = await fetch(`${apiBase}/salas`);
                const salas = await response.json();
                salasListaDiv.innerHTML = '';
                salas.forEach(sala => {
                    const div = document.createElement('div');
                    div.textContent = sala.nome;
                    div.classList.add('sala');
                    div.dataset.id = sala._id;
                    salasListaDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Erro ao carregar salas:', error);
            }
        }

        // Criar Sala
        btnCriarSala.addEventListener('click', async () => {
            const nome = nomeSalaInput.value.trim();
            if (!nome) {
                erroSala.textContent = 'Nome da sala é necessário.';
                return;
            }
            try {
                const response = await fetch(`${apiBase}/salas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome })
                });
                const data = await response.json();
                if (response.ok) {
                    nomeSalaInput.value = '';
                    erroSala.textContent = '';
                    carregarSalas();
                } else {
                    erroSala.textContent = data.error || 'Erro ao criar sala.';
                }
            } catch (error) {
                erroSala.textContent = 'Erro ao criar sala.';
                console.error(error);
            }
        });

        // Entrar em uma Sala
        salasListaDiv.addEventListener('click', async (e) => {
            if (e.target.classList.contains('sala')) {
                const salaId = e.target.dataset.id;
                const nomeSala = e.target.textContent;
                try {
                    const response = await fetch(`${apiBase}/entrar-sala`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usuarioId, salaId })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        salaIdAtual = salaId;
                        nomeSalaAtual.textContent = `Sala: ${nomeSala}`;
                        salasSection.classList.add('hidden');
                        chatSection.classList.remove('hidden');
                        carregarMensagens();
                        // Atualizar mensagens em tempo real (opcional)
                        setInterval(carregarMensagens, 3000);
                    } else {
                        alert(data.error || 'Erro ao entrar na sala.');
                    }
                } catch (error) {
                    alert('Erro ao entrar na sala.');
                    console.error(error);
                }
            }
        });

        // Carregar Mensagens
        async function carregarMensagens() {
            if (!salaIdAtual) return;
            try {
                const response = await fetch(`${apiBase}/salas/mensagens?salaId=${salaIdAtual}`);
                const mensagens = await response.json();
                chatDiv.innerHTML = '';
                mensagens.forEach(msg => {
                    const p = document.createElement('p');
                    p.textContent = `${msg.mensagem} (${new Date(msg.criadoEm).toLocaleTimeString()})`;
                    chatDiv.appendChild(p);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight;
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        // Enviar Mensagem
        btnEnviar.addEventListener('click', async () => {
            const mensagem = document.getElementById('mensagem').value.trim();
            if (!mensagem) {
                erroChat.textContent = 'Mensagem não pode ser vazia.';
                return;
            }
            try {
                const response = await fetch(`${apiBase}/salas/mensagens`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ salaId: salaIdAtual, mensagem })
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('mensagem').value = '';
                    erroChat.textContent = '';
                    carregarMensagens();
                } else {
                    erroChat.textContent = data.error || 'Erro ao enviar mensagem.';
                }
            } catch (error) {
                erroChat.textContent = 'Erro ao enviar mensagem.';
                console.error(error);
            }
        });

        // Sair da Sala
        btnSairChat.addEventListener('click', async () => {
            if (!salaIdAtual) return;
            try {
                const response = await fetch(`${apiBase}/sair-sala`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuarioId, salaId: salaIdAtual })
                });
                const data = await response.json();
                if (response.ok) {
                    salaIdAtual = null;
                    chatSection.classList.add('hidden');
                    salasSection.classList.remove('hidden');
                } else {
                    alert(data.error || 'Erro ao sair da sala.');
                }
            } catch (error) {
                alert('Erro ao sair da sala.');
                console.error(error);
            }
        });
        btnSairSalas.addEventListener('click', () => {

            window.location.reload();
        });

    </script>
</body>
</html>
